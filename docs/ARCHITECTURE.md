# Fat Burn Alarm - System Architecture

ìš´ë™ ì™„ë£Œ ì‹œ ì²´ì§€ë°© ê°ëŸ‰ëŸ‰ì„ ê³„ì‚°í•˜ì—¬ Strava í™œë™ Descriptionì— ì—…ë°ì´íŠ¸í•˜ëŠ” ì‹œìŠ¤í…œ

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Strava    â”‚â”€â”€â”€â”€â–¶â”‚  Fat Burn   â”‚â”€â”€â”€â”€â–¶â”‚   Strava    â”‚
â”‚  Webhook    â”‚     â”‚   Alarm     â”‚     â”‚ Description â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Supabase   â”‚
                    â”‚  (Database) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### 1. ì‚¬ìš©ì ë“±ë¡ (ìµœì´ˆ 1íšŒ)

```
[ì‚¬ìš©ì] â”€â”€â–¶ [Strava OAuth] â”€â”€â–¶ [Token ë°œê¸‰] â”€â”€â–¶ [Supabase ì €ì¥]
                                                       â”‚
                                                       â–¼
                                              [Webhook êµ¬ë… ë“±ë¡]
```

### 2. ìš´ë™ ì™„ë£Œ ì‹œ Description ì—…ë°ì´íŠ¸ íë¦„

```
[Strava]                     [Fat Burn Alarm]                    [Strava]
    â”‚                              â”‚                                  â”‚
    â”‚  1. Webhook Event            â”‚                                  â”‚
    â”‚  (activity.create)           â”‚                                  â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                                  â”‚
    â”‚                              â”‚                                  â”‚
    â”‚                              â”‚ 2. ì‚¬ìš©ì í† í° ì¡°íšŒ              â”‚
    â”‚                              â”‚    (Supabase)                    â”‚
    â”‚                              â”‚                                  â”‚
    â”‚  3. Activity API í˜¸ì¶œ        â”‚                                  â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
    â”‚                              â”‚                                  â”‚
    â”‚  4. í™œë™ ë°ì´í„° ë°˜í™˜         â”‚                                  â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                                  â”‚
    â”‚                              â”‚                                  â”‚
    â”‚                              â”‚ 5. ì²´ì§€ë°© ê°ëŸ‰ ê³„ì‚°              â”‚
    â”‚                              â”‚    (calories â†’ fat_burned_g)     â”‚
    â”‚                              â”‚                                  â”‚
    â”‚                              â”‚ 6. ìŒì‹ ë§¤ì¹­ (ëœë¤)              â”‚
    â”‚                              â”‚    (fat_burned_g â†’ food)         â”‚
    â”‚                              â”‚                                  â”‚
    â”‚                              â”‚ 7. Description ìƒì„±              â”‚
    â”‚                              â”‚    (ì´ëª¨ì§€ í…ìŠ¤íŠ¸ ì•„íŠ¸)          â”‚
    â”‚                              â”‚                                  â”‚
    â”‚                              â”‚ 8. Activity ì—…ë°ì´íŠ¸             â”‚
    â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                              â”‚                                  â”‚
```

## Core Components

### 1. Setup Strava (`setup-strava`)

ìµœì´ˆ OAuth ì¸ì¦ ë° Webhook êµ¬ë… ë“±ë¡

| ì—­í•  | ì„¤ëª… |
|------|------|
| OAuth ì¸ì¦ | Strava ë¡œê·¸ì¸ â†’ Authorization Code â†’ Token ë°œê¸‰ |
| ì‚¬ìš©ì ì €ì¥ | Supabaseì— í† í° ë° ì‚¬ìš©ì ì •ë³´ ì €ì¥ |
| Webhook ë“±ë¡ | Strava Push Subscription ë“±ë¡ |

**Endpoints:**
- `GET /auth/strava` - OAuth ì¸ì¦ ì‹œì‘
- `GET /auth/callback` - ì¸ì¦ ì½œë°± ì²˜ë¦¬

**í•„ìš” Scope:** `activity:read_all,activity:write`

### 2. Handle Webhook (`handle-webhook`)

Strava Webhook ì´ë²¤íŠ¸ ìˆ˜ì‹  ë° í™œë™ ë°ì´í„° ì¡°íšŒ

| ì—­í•  | ì„¤ëª… |
|------|------|
| ì´ë²¤íŠ¸ ìˆ˜ì‹  | `activity.create` ì´ë²¤íŠ¸ ì²˜ë¦¬ |
| í† í° ê´€ë¦¬ | ë§Œë£Œëœ í† í° ìë™ ê°±ì‹  |
| ë°ì´í„° ì¡°íšŒ | Strava APIë¡œ í™œë™ ìƒì„¸ ì •ë³´ ì¡°íšŒ |

**Endpoint:**
- `POST /webhook/strava` - Webhook ì´ë²¤íŠ¸ ìˆ˜ì‹ 

### 3. Calculate FatBurn (`calculate-fatburn`)

ì†Œëª¨ ì¹¼ë¡œë¦¬ë¥¼ ì²´ì§€ë°© ê°ëŸ‰ëŸ‰ìœ¼ë¡œ ë³€í™˜

| í•­ëª© | ê°’ |
|------|-----|
| ë³€í™˜ ê³µì‹ | `ì²´ì§€ë°©(g) = (ì¹¼ë¡œë¦¬ / 7,700) Ã— 1,000` |
| ê¸°ì¤€ | ì²´ì§€ë°© 1kg = 7,700 kcal |
| ì¶œë ¥ ë‹¨ìœ„ | gram (ì†Œìˆ˜ì  2ìë¦¬) |

**ì˜ˆì‹œ:**
| ì†Œëª¨ ì¹¼ë¡œë¦¬ | ì²´ì§€ë°© ê°ëŸ‰ |
|-------------|-------------|
| 100 kcal | 13g |
| 320 kcal | 42g |
| 770 kcal | 100g |

### 4. Food Matcher (`food-matcher`)

ì²´ì§€ë°© ê°ëŸ‰ëŸ‰ì— ë”°ë¥¸ ìŒì‹ ë§¤ì¹­

| ì—­í•  | ì„¤ëª… |
|------|------|
| êµ¬ê°„ íŒë³„ | ì²´ì§€ë°©ëŸ‰ì— ë”°ë¼ 6ê°œ êµ¬ê°„ ì¤‘ ì„ íƒ |
| ëœë¤ ì„ íƒ | í•´ë‹¹ êµ¬ê°„ì˜ 10ê°œ ìŒì‹ ì¤‘ ëœë¤ ì„ íƒ |
| ë°˜í™˜ | ì´ëª¨ì§€ + ìŒì‹ëª… |

**ìŒì‹ êµ¬ê°„:**
| ë²”ìœ„ | ìŒì‹ ì˜ˆì‹œ (ê° 10ê°œ) |
|------|---------------------|
| ~20g | ğŸ“ë”¸ê¸°, ğŸ‡í¬ë„, ğŸ¬ì‚¬íƒ•, ğŸ§ë¯¸ë‹ˆë¨¸í•€, ğŸªì¿ í‚¤... |
| ~40g | ğŸŒë°”ë‚˜ë‚˜, ğŸ¥šê³„ë€, ğŸ™ì‚¼ê°ê¹€ë°¥ë°˜ê°œ, ğŸ¥ë¯¸ë‹ˆí¬ë¡œì•„ìƒ... |
| ~70g | ğŸì‚¬ê³¼, ğŸë°°, ğŸ¥¯ë² ì´ê¸€, ğŸ™ì‚¼ê°ê¹€ë°¥... |
| ~100g | ğŸ©ë„ë„›, ğŸ§‡ì™€í”Œ, ğŸ¥íŒ¬ì¼€ì´í¬2ì¥, ğŸŒ®íƒ€ì½”... |
| ~150g | ğŸ”í–„ë²„ê±°, ğŸ•í”¼ì1ì¡°ê°, ğŸœë¼ë©´, ğŸ›ì¹´ë ˆ... |
| 150g+ | ğŸ–ìŠ¤í…Œì´í¬, ğŸ—ì¹˜í‚¨1ì¡°ê°, ğŸ•í”¼ì2ì¡°ê°... |

### 5. Update Description (`update-description`)

Strava í™œë™ Description ìƒì„± ë° ì—…ë°ì´íŠ¸

| ì—­í•  | ì„¤ëª… |
|------|------|
| í…œí”Œë¦¿ ìƒì„± | ì´ëª¨ì§€ ê¸°ë°˜ í…ìŠ¤íŠ¸ ì•„íŠ¸ ìƒì„± |
| API í˜¸ì¶œ | Strava `PUT /activities/{id}` |
| ê¸°ì¡´ ë³´ì¡´ | ê¸°ì¡´ Description ì•„ë˜ì— ì¶”ê°€ |

**Description í…œí”Œë¦¿:**
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ Fat Burn Report
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ {distance}km | â±ï¸ {duration}ë¶„
ğŸ”¥ {calories}kcal ì†Œëª¨

{food_emoji} ì²´ì§€ë°© {fat_burned_g}g ê°ëŸ‰!
   â‰ˆ {food_name} íƒœì› ì–´ìš”!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## External Services

### Strava API

| ìš©ë„ | Endpoint |
|------|----------|
| OAuth ì¸ì¦ | `https://www.strava.com/oauth/authorize` |
| Token ë°œê¸‰ | `https://www.strava.com/oauth/token` |
| í™œë™ ì¡°íšŒ | `GET /api/v3/activities/{id}` |
| í™œë™ ì—…ë°ì´íŠ¸ | `PUT /api/v3/activities/{id}` |
| Webhook êµ¬ë… | `POST /api/v3/push_subscriptions` |

**í•„ìš” Scope:** `activity:read_all,activity:write`

### Supabase

ì‚¬ìš©ì ì •ë³´ ë° ì¸ì¦ í† í° ì €ì¥

| í•„ë“œ | ì„¤ëª… |
|------|------|
| strava_id | Strava ì‚¬ìš©ì ID |
| strava_nickname | Strava ë‹‰ë„¤ì„ |
| access_token | API í˜¸ì¶œìš© í† í° |
| refresh_token | í† í° ê°±ì‹ ìš© |
| token_expires_at | í† í° ë§Œë£Œ ì‹œê°„ |

## Environment Variables

| ë³€ìˆ˜ëª… | ì„¤ëª… |
|--------|------|
| `STRAVA_CLIENT_ID` | Strava ì•± Client ID |
| `STRAVA_CLIENT_SECRET` | Strava ì•± Client Secret |
| `STRAVA_VERIFY_TOKEN` | Webhook ê²€ì¦ í† í° |
| `SUPABASE_URL` | Supabase í”„ë¡œì íŠ¸ URL |
| `SUPABASE_KEY` | Supabase API Key |

## Error Handling

| ì»´í¬ë„ŒíŠ¸ | ì—ëŸ¬ | ì²˜ë¦¬ |
|----------|------|------|
| Setup | Invalid Code | ì¬ì¸ì¦ ìš”ì²­ |
| Setup | Duplicate User | ê¸°ì¡´ í† í° ì—…ë°ì´íŠ¸ |
| Webhook | ì‚¬ìš©ì ì—†ìŒ | ë¬´ì‹œ (ë¡œê·¸ ê¸°ë¡) |
| Webhook | í† í° ê°±ì‹  ì‹¤íŒ¨ | ë¡œê·¸ ê¸°ë¡, 200 ì‘ë‹µ |
| Webhook | í™œë™ ì¡°íšŒ ì‹¤íŒ¨ | 3íšŒ ì¬ì‹œë„ |
| Webhook | calories ì—†ìŒ | distance ê¸°ë°˜ ì¶”ì • |
| Description | ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ | ë¡œê·¸ ê¸°ë¡, 200 ì‘ë‹µ |

## API Endpoints Summary

| Method | Path | ì„¤ëª… |
|--------|------|------|
| GET | `/auth/strava` | Strava OAuth ì‹œì‘ |
| GET | `/auth/callback` | OAuth ì½œë°± ì²˜ë¦¬ |
| GET | `/webhook/strava` | Webhook ê²€ì¦ (subscribe) |
| POST | `/webhook/strava` | Webhook ì´ë²¤íŠ¸ ìˆ˜ì‹  |